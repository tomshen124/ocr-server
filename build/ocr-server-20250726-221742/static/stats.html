<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR预审系统统计中心</title>
    <style>
        /* 政务系统统计页面样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* 头部导航 */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
        }
        
        .header-title .icon {
            margin-right: 12px;
            font-size: 28px;
        }
        
        .header-nav {
            display: flex;
            gap: 24px;
        }
        
        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 10px 18px;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        
        .header-nav a:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        /* 主容器 */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* 面包屑导航 */
        .breadcrumb {
            background: white;
            padding: 14px 24px;
            margin-bottom: 24px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 14px;
            color: #666;
            border-left: 4px solid #1890ff;
        }
        
        /* 统计卡片网格 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1890ff, #40a9ff);
        }
        
        .stats-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .stats-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .stats-card-title .icon {
            margin-right: 8px;
            font-size: 20px;
            color: #1890ff;
        }
        
        .stats-value {
            font-size: 36px;
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 8px;
        }
        
        .stats-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        
        .stats-trend {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .trend-up {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .trend-down {
            background: #fff2f0;
            color: #ff4d4f;
        }
        
        .trend-stable {
            background: #f0f5ff;
            color: #1890ff;
        }
        
        /* 图表容器 */
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
            margin-bottom: 24px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .chart-title .icon {
            margin-right: 10px;
            font-size: 22px;
            color: #1890ff;
        }
        
        /* 时间选择器 */
        .time-selector {
            display: flex;
            gap: 8px;
        }
        
        .time-btn {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .time-btn.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .time-btn:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        /* 表格样式 */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .stats-table th {
            background: #fafafa;
            font-weight: 600;
            color: #333;
        }
        
        .stats-table tr:hover {
            background: #f5f5f5;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background: #73d13d;
            transform: translateY(-1px);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .header-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .main-container {
                padding: 16px;
            }
            
            .chart-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- 头部导航 -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <span class="icon">📊</span>
                OCR预审系统统计中心
            </div>
            <div class="header-nav">
                <a href="/">返回主页</a>
                <a href="/preview">预审页面</a>
                <a href="/monitoring.html">监控中心</a>
                <a href="/static/test-tools.html">测试工具</a>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 面包屑导航 -->
        <div class="breadcrumb">
            首页 > 系统管理 > 统计中心
        </div>

        <!-- 统计概览 -->
        <div class="stats-grid">
            <!-- 总处理量 -->
            <div class="stats-card">
                <div class="stats-card-header">
                    <div class="stats-card-title">
                        <span class="icon">📄</span>
                        总处理量
                    </div>
                </div>
                <div id="totalProcessed" class="stats-value">0</div>
                <div class="stats-label">累计处理文件数</div>
                <div class="stats-trend trend-up">↗ 较昨日 +12%</div>
            </div>

            <!-- 今日处理量 -->
            <div class="stats-card">
                <div class="stats-card-header">
                    <div class="stats-card-title">
                        <span class="icon">📅</span>
                        今日处理量
                    </div>
                </div>
                <div id="todayProcessed" class="stats-value">0</div>
                <div class="stats-label">今日处理文件数</div>
                <div class="stats-trend trend-up">↗ 较昨日 +8%</div>
            </div>

            <!-- 成功率 -->
            <div class="stats-card">
                <div class="stats-card-header">
                    <div class="stats-card-title">
                        <span class="icon">✅</span>
                        处理成功率
                    </div>
                </div>
                <div id="successRate" class="stats-value">0%</div>
                <div class="stats-label">预审通过率</div>
                <div class="stats-trend trend-stable">→ 保持稳定</div>
            </div>

            <!-- 平均处理时间 -->
            <div class="stats-card">
                <div class="stats-card-header">
                    <div class="stats-card-title">
                        <span class="icon">⏱️</span>
                        平均处理时间
                    </div>
                </div>
                <div id="avgProcessTime" class="stats-value">0s</div>
                <div class="stats-label">单个文件处理时长</div>
                <div class="stats-trend trend-down">↘ 较昨日 -5%</div>
            </div>

            <!-- 活跃用户数 -->
            <div class="stats-card">
                <div class="stats-card-header">
                    <div class="stats-card-title">
                        <span class="icon">👥</span>
                        活跃用户数
                    </div>
                </div>
                <div id="activeUsers" class="stats-value">0</div>
                <div class="stats-label">今日活跃用户</div>
                <div class="stats-trend trend-up">↗ 较昨日 +15%</div>
            </div>

            <!-- 系统负载 -->
            <div class="stats-card">
                <div class="stats-card-header">
                    <div class="stats-card-title">
                        <span class="icon">⚡</span>
                        系统负载
                    </div>
                </div>
                <div id="systemLoad" class="stats-value">0%</div>
                <div class="stats-label">当前系统负载</div>
                <div class="stats-trend trend-stable">→ 运行正常</div>
            </div>
        </div>

        <!-- 处理量趋势图 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <span class="icon">📈</span>
                    处理量趋势分析
                </div>
                <div class="time-selector">
                    <button class="time-btn active" onclick="changeTimeRange('today')">今日</button>
                    <button class="time-btn" onclick="changeTimeRange('week')">本周</button>
                    <button class="time-btn" onclick="changeTimeRange('month')">本月</button>
                    <button class="time-btn" onclick="changeTimeRange('year')">本年</button>
                </div>
            </div>
            <div id="trendChart" style="height: 300px; background: #fafafa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #666;">
                处理量趋势图表加载中...
            </div>
        </div>

        <!-- 主题使用统计 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <span class="icon">🎯</span>
                    主题使用统计
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="refreshThemeStats()">刷新数据</button>
                    <button class="btn btn-success" onclick="exportThemeStats()">导出报表</button>
                </div>
            </div>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>主题名称</th>
                        <th>使用次数</th>
                        <th>成功率</th>
                        <th>平均处理时间</th>
                        <th>最后使用时间</th>
                    </tr>
                </thead>
                <tbody id="themeStatsTable">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #666;">正在加载数据...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 预审记录统计 -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <span class="icon">📋</span>
                    预审记录统计
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="refreshUserStats()">刷新数据</button>
                </div>
            </div>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>预审ID</th>
                        <th>事项名称</th>
                        <th>用户ID</th>
                        <th>处理状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="userStatsTable">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">正在加载数据...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 页脚信息 -->
        <div style="text-align: center; padding: 24px; color: #666; border-top: 1px solid #e8e8e8; margin-top: 40px; background: white; border-radius: 8px;">
            <p style="margin-bottom: 8px; font-weight: 600;">OCR预审系统统计中心 v2.0</p>
            <p style="font-size: 14px; margin: 0;">数据统计与分析 | 自动更新时间: <span id="lastUpdateTime">--</span></p>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTimeRange = 'today';
        let statsData = {};

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeStats();
            loadAllStats();
        });

        // 初始化统计页面
        function initializeStats() {
            updateLastUpdateTime();
            console.log('统计中心初始化完成');
        }

        // 加载所有统计数据
        async function loadAllStats() {
            try {
                await Promise.all([
                    loadOverviewStats(),
                    loadThemeStats(),
                    loadUserStats(),
                    loadTrendData()
                ]);
                updateLastUpdateTime();
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载概览统计
        async function loadOverviewStats() {
            try {
                // 模拟API调用 - 实际项目中替换为真实API
                const response = await fetch('/api/stats/overview');
                let data;

                if (response.ok) {
                    data = await response.json();
                } else {
                    // 使用模拟数据
                    data = {
                        success: true,
                        data: {
                            totalProcessed: 15847,
                            todayProcessed: 234,
                            successRate: 94.2,
                            avgProcessTime: 2.3,
                            activeUsers: 45,
                            systemLoad: 23.5
                        }
                    };
                }

                if (data.success) {
                    updateOverviewDisplay(data.data);
                }
            } catch (error) {
                console.error('加载概览统计失败:', error);
                // 使用默认数据
                updateOverviewDisplay({
                    totalProcessed: 0,
                    todayProcessed: 0,
                    successRate: 0,
                    avgProcessTime: 0,
                    activeUsers: 0,
                    systemLoad: 0
                });
            }
        }

        // 更新概览显示
        function updateOverviewDisplay(data) {
            document.getElementById('totalProcessed').textContent = formatNumber(data.totalProcessed);
            document.getElementById('todayProcessed').textContent = formatNumber(data.todayProcessed);
            document.getElementById('successRate').textContent = data.successRate.toFixed(1) + '%';
            document.getElementById('avgProcessTime').textContent = data.avgProcessTime.toFixed(1) + 's';
            document.getElementById('activeUsers').textContent = formatNumber(data.activeUsers);
            document.getElementById('systemLoad').textContent = data.systemLoad.toFixed(1) + '%';
        }

        // 加载主题统计
        async function loadThemeStats() {
            try {
                const response = await fetch('/api/stats/themes');
                let data;

                if (response.ok) {
                    data = await response.json();
                } else {
                    // 使用模拟数据
                    data = {
                        success: true,
                        data: [
                            { name: '身份证识别', count: 5234, successRate: 96.8, avgTime: 1.8, lastUsed: '2025-01-22 14:30:25' },
                            { name: '营业执照识别', count: 3421, successRate: 94.2, avgTime: 2.1, lastUsed: '2025-01-22 14:25:10' },
                            { name: '银行卡识别', count: 2876, successRate: 98.1, avgTime: 1.5, lastUsed: '2025-01-22 14:20:45' },
                            { name: '驾驶证识别', count: 1987, successRate: 92.5, avgTime: 2.3, lastUsed: '2025-01-22 14:15:30' },
                            { name: '房产证识别', count: 1543, successRate: 89.7, avgTime: 3.2, lastUsed: '2025-01-22 14:10:15' },
                            { name: '学历证书识别', count: 987, successRate: 91.3, avgTime: 2.8, lastUsed: '2025-01-22 14:05:00' }
                        ]
                    };
                }

                if (data.success) {
                    updateThemeStatsTable(data.data);
                }
            } catch (error) {
                console.error('加载主题统计失败:', error);
                updateThemeStatsTable([]);
            }
        }

        // 更新主题统计表格
        function updateThemeStatsTable(themes) {
            const tbody = document.getElementById('themeStatsTable');

            if (themes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">暂无数据</td></tr>';
                return;
            }

            let html = '';
            themes.forEach(theme => {
                html += `
                    <tr>
                        <td>${theme.name}</td>
                        <td>${formatNumber(theme.count)}</td>
                        <td>${theme.successRate.toFixed(1)}%</td>
                        <td>${theme.avgTime.toFixed(1)}s</td>
                        <td>${theme.lastUsed}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // 加载用户统计
        async function loadUserStats() {
            try {
                const response = await fetch('/api/stats/previews?limit=50');
                let data;

                if (response.ok) {
                    data = await response.json();
                } else {
                    // 使用模拟数据
                    data = {
                        success: true,
                        data: {
                            records: [
                                { id: 'PV001', matter_name: '工程渣土准运证核准', created_at: '2025-01-22T14:30:25Z', status: 'completed', user_id: '1472176' },
                                { id: 'PV002', matter_name: '排水接管技术审查', created_at: '2025-01-22T14:25:10Z', status: 'completed', user_id: '1472177' }
                            ]
                        }
                    };
                }

                if (data.success && data.data.records) {
                    updatePreviewStatsTable(data.data.records);
                }
            } catch (error) {
                console.error('加载预审统计失败:', error);
                updatePreviewStatsTable([]);
            }
        }

        // 更新预审统计表格
        function updatePreviewStatsTable(records) {
            const tbody = document.getElementById('userStatsTable');

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">暂无数据</td></tr>';
                return;
            }

            let html = '';
            records.forEach(record => {
                const formatDate = new Date(record.created_at).toLocaleString();
                const statusText = record.status === 'completed' ? '已完成' : 
                                 record.status === 'processing' ? '处理中' : 
                                 record.status === 'pending' ? '待处理' : '未知';
                
                html += `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.matter_name}</td>
                        <td>${record.user_id}</td>
                        <td>${statusText}</td>
                        <td>${formatDate}</td>
                        <td><a href="/api/preview/view/${record.id}" target="_blank">查看</a></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // 加载趋势数据
        async function loadTrendData() {
            try {
                const response = await fetch(`/api/stats/trend?range=${currentTimeRange}`);
                let data;

                if (response.ok) {
                    data = await response.json();
                } else {
                    // 使用模拟数据
                    data = {
                        success: true,
                        data: generateMockTrendData(currentTimeRange)
                    };
                }

                if (data.success) {
                    updateTrendChart(data.data);
                }
            } catch (error) {
                console.error('加载趋势数据失败:', error);
                updateTrendChart([]);
            }
        }

        // 生成模拟趋势数据
        function generateMockTrendData(range) {
            const data = [];
            let points = 24; // 默认24小时

            switch (range) {
                case 'today':
                    points = 24;
                    break;
                case 'week':
                    points = 7;
                    break;
                case 'month':
                    points = 30;
                    break;
                case 'year':
                    points = 12;
                    break;
            }

            for (let i = 0; i < points; i++) {
                data.push({
                    time: i,
                    value: Math.floor(Math.random() * 100) + 20
                });
            }

            return data;
        }

        // 更新趋势图表
        function updateTrendChart(data) {
            const chartContainer = document.getElementById('trendChart');

            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<div style="color: #666;">暂无趋势数据</div>';
                return;
            }

            // 简单的柱状图显示
            let html = '<div style="display: flex; align-items: end; justify-content: space-between; height: 250px; padding: 20px;">';

            const maxValue = Math.max(...data.map(d => d.value));

            data.forEach((point, index) => {
                const height = (point.value / maxValue) * 200;
                const color = index % 2 === 0 ? '#1890ff' : '#40a9ff';

                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="background: ${color}; width: 20px; height: ${height}px; border-radius: 2px; margin-bottom: 8px;"></div>
                        <div style="font-size: 12px; color: #666;">${point.time}</div>
                        <div style="font-size: 10px; color: #999;">${point.value}</div>
                    </div>
                `;
            });

            html += '</div>';
            chartContainer.innerHTML = html;
        }

        // 切换时间范围
        function changeTimeRange(range) {
            currentTimeRange = range;

            // 更新按钮状态
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 重新加载趋势数据
            loadTrendData();
        }

        // 刷新主题统计
        function refreshThemeStats() {
            loadThemeStats();
        }

        // 导出主题统计
        function exportThemeStats() {
            alert('导出功能开发中...');
        }

        // 刷新用户统计
        function refreshUserStats() {
            loadUserStats();
        }

        // 格式化数字
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + '万';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleString();
        }

        // 定期刷新数据
        setInterval(() => {
            loadAllStats();
        }, 300000); // 5分钟刷新一次
    </script>
</body>
</html>
