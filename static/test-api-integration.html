<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯APIé›†æˆæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å‰ç«¯APIé›†æˆæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. è®¤è¯æµ‹è¯•</h2>
        <button onclick="testAuth()">æµ‹è¯•è°ƒè¯•ç¥¨æ®è®¤è¯</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2>2. é¢„å®¡è¯·æ±‚æµ‹è¯•</h2>
        <button onclick="testPreviewRequest()">åˆ›å»ºé¢„å®¡è¯·æ±‚</button>
        <div id="preview-request-result"></div>
    </div>

    <div class="test-section">
        <h2>3. é˜Ÿåˆ—çŠ¶æ€æµ‹è¯•</h2>
        <button onclick="testQueueStatus()">è·å–é˜Ÿåˆ—çŠ¶æ€</button>
        <div id="queue-status-result"></div>
    </div>

    <div class="test-section">
        <h2>4. é¢„å®¡æ•°æ®è·å–æµ‹è¯•</h2>
        <input type="text" id="preview-id" placeholder="è¾“å…¥é¢„å®¡ID" style="width: 300px;">
        <button onclick="testPreviewData()">è·å–é¢„å®¡æ•°æ®</button>
        <div id="preview-data-result"></div>
    </div>

    <div class="test-section">
        <h2>5. å‰ç«¯ç»„ä»¶æµ‹è¯•</h2>
        <button onclick="testFrontendComponents()">æµ‹è¯•æ•°æ®è½¬æ¢</button>
        <div id="component-test-result"></div>
    </div>

    <!-- å¼•å…¥å‰ç«¯è„šæœ¬ -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨æµ‹è¯•ç»“æœ
        let currentPreviewId = null;

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function showJsonResult(containerId, data, type = 'success') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="test-result ${type}">
                    <strong>å“åº”æ•°æ®:</strong>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        // 1. æµ‹è¯•è®¤è¯
        async function testAuth() {
            showResult('auth-result', 'æ­£åœ¨æµ‹è¯•è®¤è¯...', 'info');
            try {
                const result = await window.apiService.debugTicketAuth();
                if (result.success) {
                    showJsonResult('auth-result', result, 'success');
                } else {
                    showResult('auth-result', `è®¤è¯å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('auth-result', `è®¤è¯å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 2. æµ‹è¯•é¢„å®¡è¯·æ±‚
        async function testPreviewRequest() {
            showResult('preview-request-result', 'æ­£åœ¨åˆ›å»ºé¢„å®¡è¯·æ±‚...', 'info');
            try {
                const requestData = {
                    agentInfo: {
                        userId: "debug_user_e4a0dc3fcc",
                        certificateType: "èº«ä»½è¯"
                    },
                    subjectInfo: {
                        userId: "debug_user_e4a0dc3fcc", 
                        certificateType: "èº«ä»½è¯"
                    },
                    channel: "web",
                    copy: false,
                    formData: [],
                    materialData: [
                        {
                            code: "MATERIAL_TEST_001",
                            attachmentList: [
                                {
                                    attaName: "æµ‹è¯•æ–‡æ¡£.pdf",
                                    attaUrl: "data:application/pdf;base64,test_frontend_data",
                                    isCloudShare: false
                                }
                            ]
                        }
                    ],
                    matterId: "101104353",
                    matterName: "å·¥ç¨‹æ¸£åœŸå‡†è¿è¯æ ¸å‡†",
                    matterType: "è®¸å¯",
                    requestId: "frontend_test_" + Date.now(),
                    sequenceNo: "20250818" + String(Date.now()).slice(-6)
                };

                const result = await window.apiService.startAudit(requestData);
                if (result.success) {
                    currentPreviewId = result.data.previewId;
                    document.getElementById('preview-id').value = currentPreviewId;
                    showJsonResult('preview-request-result', result, 'success');
                } else {
                    showResult('preview-request-result', `é¢„å®¡è¯·æ±‚å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('preview-request-result', `é¢„å®¡è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 3. æµ‹è¯•é˜Ÿåˆ—çŠ¶æ€
        async function testQueueStatus() {
            showResult('queue-status-result', 'æ­£åœ¨è·å–é˜Ÿåˆ—çŠ¶æ€...', 'info');
            try {
                const result = await window.apiService.getQueueStatus();
                if (result.success) {
                    showJsonResult('queue-status-result', result, 'success');
                } else {
                    showResult('queue-status-result', `è·å–é˜Ÿåˆ—çŠ¶æ€å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('queue-status-result', `é˜Ÿåˆ—çŠ¶æ€è·å–å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 4. æµ‹è¯•é¢„å®¡æ•°æ®è·å–
        async function testPreviewData() {
            const previewId = document.getElementById('preview-id').value.trim();
            if (!previewId) {
                showResult('preview-data-result', 'è¯·è¾“å…¥é¢„å®¡ID', 'error');
                return;
            }

            showResult('preview-data-result', `æ­£åœ¨è·å–é¢„å®¡æ•°æ®: ${previewId}...`, 'info');
            try {
                const result = await window.apiService.getMaterialsList(previewId);
                if (result.success) {
                    // æµ‹è¯•æ•°æ®è½¬æ¢
                    const transformedData = window.apiService.transformPreviewData(result);
                    showJsonResult('preview-data-result', {
                        åŸå§‹æ•°æ®: result,
                        è½¬æ¢åæ•°æ®: transformedData
                    }, 'success');
                } else {
                    showResult('preview-data-result', `è·å–é¢„å®¡æ•°æ®å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('preview-data-result', `é¢„å®¡æ•°æ®è·å–å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 5. æµ‹è¯•å‰ç«¯ç»„ä»¶åŠŸèƒ½
        async function testFrontendComponents() {
            showResult('component-test-result', 'æ­£åœ¨æµ‹è¯•å‰ç«¯ç»„ä»¶...', 'info');
            
            // æµ‹è¯•é…ç½®å·¥å…·
            const testResults = {
                é…ç½®å·¥å…·æµ‹è¯•: {},
                APIç«¯ç‚¹æµ‹è¯•: {},
                æ•°æ®æ˜ å°„æµ‹è¯•: {}
            };

            try {
                // æµ‹è¯•é…ç½®å·¥å…·
                if (window.CONFIG && window.CONFIG.ConfigUtils) {
                    const utils = window.CONFIG.ConfigUtils;
                    
                    // æµ‹è¯•API URLç”Ÿæˆ
                    const testUrl = utils.getApiUrl('previewData', { previewId: 'test123' });
                    testResults.é…ç½®å·¥å…·æµ‹è¯•.API_URLç”Ÿæˆ = testUrl;
                    
                    // æµ‹è¯•ç¯å¢ƒæ£€æµ‹
                    const env = utils.getEnvironment();
                    testResults.é…ç½®å·¥å…·æµ‹è¯•.ç¯å¢ƒæ£€æµ‹ = env;
                    
                    // æµ‹è¯•å­—æ®µæ˜ å°„
                    const testData = { applicant_name: 'æµ‹è¯•ç”¨æˆ·', matter_name: 'æµ‹è¯•äº‹é¡¹' };
                    const mappedValue = utils.mapField(testData, 'applicant_name');
                    testResults.é…ç½®å·¥å…·æµ‹è¯•.å­—æ®µæ˜ å°„ = mappedValue;
                }

                // æµ‹è¯•APIç«¯ç‚¹é…ç½®
                if (window.CONFIG && window.CONFIG.API_CONFIG) {
                    testResults.APIç«¯ç‚¹æµ‹è¯• = {
                        baseUrl: window.CONFIG.API_CONFIG.baseUrl,
                        endpoints: Object.keys(window.CONFIG.API_CONFIG.endpoints).length + ' ä¸ªç«¯ç‚¹',
                        ç¤ºä¾‹ç«¯ç‚¹: window.CONFIG.API_CONFIG.endpoints.previewData
                    };
                }

                // æµ‹è¯•æ•°æ®æ˜ å°„é…ç½®
                if (window.CONFIG && window.CONFIG.DATA_MAPPING) {
                    testResults.æ•°æ®æ˜ å°„æµ‹è¯• = {
                        çŠ¶æ€æ˜ å°„: window.CONFIG.DATA_MAPPING.preview.statusMapping,
                        å®¡æ ¸çŠ¶æ€æ˜ å°„: window.CONFIG.DATA_MAPPING.preview.auditStatusMapping
                    };
                }

                showJsonResult('component-test-result', testResults, 'success');
            } catch (error) {
                showResult('component-test-result', `ç»„ä»¶æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•åŸºç¡€åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥å¿…è¦çš„å…¨å±€å¯¹è±¡æ˜¯å¦å­˜åœ¨
            const checkResults = {
                CONFIG: !!window.CONFIG,
                ApiService: !!window.apiService,
                ConfigUtils: !!(window.CONFIG && window.CONFIG.ConfigUtils)
            };
            
            console.log('ğŸ” å‰ç«¯ç»„ä»¶æ£€æŸ¥:', checkResults);
            
            if (checkResults.CONFIG && checkResults.ApiService) {
                console.log('âœ… å‰ç«¯ç»„ä»¶åŠ è½½æ­£å¸¸');
            } else {
                console.log('âŒ å‰ç«¯ç»„ä»¶åŠ è½½å¼‚å¸¸');
            }
        });
    </script>
</body>
</html>