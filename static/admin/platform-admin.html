<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬ä¸‰æ–¹å¹³å°é›†æˆç®¡ç† - OCRæ™ºèƒ½é¢„å®¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/modals.css">
    <style>
        .platform-admin {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
        }

        .admin-header p {
            margin: 10px 0 0;
            opacity: 0.9;
        }

        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .admin-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            background: #667eea;
            color: white;
        }

        .admin-tab:hover {
            background: #5a67d8;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stats-card h3 {
            margin: 0 0 10px;
            font-size: 32px;
            font-weight: bold;
        }

        .stats-card p {
            margin: 0;
            color: #666;
        }

        .clients-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .client-table {
            width: 100%;
            border-collapse: collapse;
        }

        .client-table th,
        .client-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .client-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .client-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .permissions-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .permission-tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .api-usage-chart {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="platform-admin">
        <div class="admin-header">
            <h1>ğŸš€ ç¬¬ä¸‰æ–¹å¹³å°é›†æˆç®¡ç†</h1>
            <p>ç®¡ç†APIç½‘å…³ã€å®¢æˆ·ç«¯è®¤è¯å’Œè°ƒç”¨é‡ç»Ÿè®¡</p>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchTab('overview')">ğŸ“Š å¹³å°æ¦‚è§ˆ</button>
            <button class="admin-tab" onclick="switchTab('clients')">ğŸ‘¥ å®¢æˆ·ç«¯ç®¡ç†</button>
            <button class="admin-tab" onclick="switchTab('statistics')">ğŸ“ˆ è°ƒç”¨ç»Ÿè®¡</button>
            <button class="admin-tab" onclick="switchTab('configuration')">âš™ï¸ å¹³å°é…ç½®</button>
        </div>

        <!-- å¹³å°æ¦‚è§ˆ -->
        <div id="overview" class="tab-content active">
            <div class="stats-cards">
                <div class="stats-card">
                    <h3 id="total-clients">-</h3>
                    <p>æ€»å®¢æˆ·ç«¯æ•°</p>
                </div>
                <div class="stats-card">
                    <h3 id="active-clients">-</h3>
                    <p>æ´»è·ƒå®¢æˆ·ç«¯</p>
                </div>
                <div class="stats-card">
                    <h3 id="today-calls">-</h3>
                    <p>ä»Šæ—¥APIè°ƒç”¨</p>
                </div>
                <div class="stats-card">
                    <h3 id="success-rate">-</h3>
                    <p>æˆåŠŸç‡</p>
                </div>
            </div>

            <div class="api-usage-chart">
                <h3>ğŸ“ˆ APIè°ƒç”¨è¶‹åŠ¿</h3>
                <div id="usage-chart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                    è°ƒç”¨é‡å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º (å¯é›†æˆChart.js)
                </div>
            </div>
        </div>

        <!-- å®¢æˆ·ç«¯ç®¡ç† -->
        <div id="clients" class="tab-content">
            <div class="clients-table">
                <div class="table-header">
                    <h3>ğŸ” APIå®¢æˆ·ç«¯åˆ—è¡¨</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showAddClientModal()">+ æ·»åŠ å®¢æˆ·ç«¯</button>
                        <button class="btn btn-secondary" onclick="refreshClients()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div id="clients-loading" class="loading">åŠ è½½å®¢æˆ·ç«¯åˆ—è¡¨...</div>
                <table class="client-table" id="clients-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>å®¢æˆ·ç«¯ID</th>
                            <th>å®¢æˆ·ç«¯åç§°</th>
                            <th>ç»„ç»‡</th>
                            <th>çŠ¶æ€</th>
                            <th>æƒé™</th>
                            <th>ä»Šæ—¥è°ƒç”¨</th>
                            <th>æˆåŠŸç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="clients-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è°ƒç”¨ç»Ÿè®¡ -->
        <div id="statistics" class="tab-content">
            <div class="api-usage-chart">
                <h3>ğŸ“Š APIè°ƒç”¨è¯¦ç»†ç»Ÿè®¡</h3>
                <div id="statistics-content" class="loading">åŠ è½½ç»Ÿè®¡æ•°æ®...</div>
            </div>
        </div>

        <!-- å¹³å°é…ç½® -->
        <div id="configuration" class="tab-content">
            <div class="clients-table">
                <div class="table-header">
                    <h3>âš™ï¸ å¹³å°é…ç½®ç®¡ç†</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="saveConfiguration()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    </div>
                </div>
                <div style="padding: 30px;">
                    <div id="config-loading" class="loading">åŠ è½½é…ç½®ä¿¡æ¯...</div>
                    <div id="config-form" style="display: none;">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="platform-enabled"> å¯ç”¨ç¬¬ä¸‰æ–¹å¹³å°è®¿é—®
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="signature-required"> è¦æ±‚è¯·æ±‚ç­¾åéªŒè¯
                            </label>
                        </div>
                        <div class="form-group">
                            <label>æ—¶é—´æˆ³å®¹å·® (ç§’)</label>
                            <input type="number" id="timestamp-tolerance" placeholder="300">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="rate-limiting-enabled"> å¯ç”¨è°ƒç”¨é‡é™åˆ¶
                            </label>
                        </div>
                        <div class="form-group">
                            <label>æ¯åˆ†é’Ÿè°ƒç”¨é™åˆ¶</label>
                            <input type="number" id="requests-per-minute" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label>æ¯å°æ—¶è°ƒç”¨é™åˆ¶</label>
                            <input type="number" id="requests-per-hour" placeholder="1000">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å®¢æˆ·ç«¯æ¨¡æ€æ¡† -->
    <div id="add-client-modal" class="modal">
        <div class="modal-content">
            <h3>â• æ·»åŠ æ–°å®¢æˆ·ç«¯</h3>
            <form id="add-client-form">
                <div class="form-group">
                    <label>å®¢æˆ·ç«¯åç§° *</label>
                    <input type="text" id="client-name" required>
                </div>
                <div class="form-group">
                    <label>ç»„ç»‡/å…¬å¸ *</label>
                    <input type="text" id="client-organization" required>
                </div>
                <div class="form-group">
                    <label>è”ç³»é‚®ç®± *</label>
                    <input type="email" id="client-email" required>
                </div>
                <div class="form-group">
                    <label>æƒé™é€‰æ‹©</label>
                    <div>
                        <label><input type="checkbox" value="preview"> é¢„å®¡æƒé™</label>
                        <label><input type="checkbox" value="status"> çŠ¶æ€æŸ¥è¯¢</label>
                        <label><input type="checkbox" value="result"> ç»“æœä¸‹è½½</label>
                        <label><input type="checkbox" value="statistics"> ç»Ÿè®¡æŸ¥è¯¢</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>ç”³è¯·è¯´æ˜</label>
                    <textarea id="client-description" rows="3"></textarea>
                </div>
                <div class="table-actions">
                    <button type="submit" class="btn btn-primary">åˆ›å»ºå®¢æˆ·ç«¯</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddClientModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const platformAdmin = {
            currentTab: 'overview',
            clients: [],
            platformStats: null,
            config: null
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializePlatformAdmin();
        });

        function initializePlatformAdmin() {
            loadPlatformStats();
            loadClients();
            loadConfiguration();
        }

        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            platformAdmin.currentTab = tabName;

            // æ ¹æ®æ ‡ç­¾åŠ è½½ä¸åŒæ•°æ®
            switch(tabName) {
                case 'overview':
                    loadPlatformStats();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'statistics':
                    loadStatistics();
                    break;
                case 'configuration':
                    loadConfiguration();
                    break;
            }
        }

        // åŠ è½½å¹³å°ç»Ÿè®¡
        async function loadPlatformStats() {
            try {
                const response = await fetch('/api/admin/platform/stats/platform');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('total-clients').textContent = stats.total_clients;
                    document.getElementById('active-clients').textContent = stats.active_clients;
                    document.getElementById('today-calls').textContent = stats.total_api_calls_today;
                    document.getElementById('success-rate').textContent = '98.5%'; // ç¤ºä¾‹æ•°æ®
                    
                    platformAdmin.platformStats = stats;
                } else {
                    console.error('åŠ è½½å¹³å°ç»Ÿè®¡å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('åŠ è½½å¹³å°ç»Ÿè®¡å¼‚å¸¸:', error);
            }
        }

        // åŠ è½½å®¢æˆ·ç«¯åˆ—è¡¨
        async function loadClients() {
            document.getElementById('clients-loading').style.display = 'block';
            document.getElementById('clients-table').style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/platform/clients');
                const result = await response.json();
                
                if (result.success) {
                    platformAdmin.clients = result.data.clients;
                    renderClientsTable();
                } else {
                    showError('åŠ è½½å®¢æˆ·ç«¯åˆ—è¡¨å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showError('åŠ è½½å®¢æˆ·ç«¯åˆ—è¡¨å¼‚å¸¸: ' + error.message);
            } finally {
                document.getElementById('clients-loading').style.display = 'none';
                document.getElementById('clients-table').style.display = 'table';
            }
        }

        // æ¸²æŸ“å®¢æˆ·ç«¯è¡¨æ ¼
        function renderClientsTable() {
            const tbody = document.getElementById('clients-tbody');
            tbody.innerHTML = '';
            
            platformAdmin.clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${client.client_id}</code></td>
                    <td>${client.client_name}</td>
                    <td>${client.organization}</td>
                    <td>
                        <span class="status-badge ${client.enabled ? 'status-enabled' : 'status-disabled'}">
                            ${client.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                        </span>
                    </td>
                    <td>
                        <div class="permissions-tags">
                            ${client.permissions.map(p => `<span class="permission-tag">${p}</span>`).join('')}
                        </div>
                    </td>
                    <td>${client.call_stats.calls_today}</td>
                    <td>${client.call_stats.success_rate.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewClientDetails('${client.client_id}')">æŸ¥çœ‹</button>
                        ${client.enabled ? 
                            `<button class="btn btn-danger" onclick="disableClient('${client.client_id}')">ç¦ç”¨</button>` :
                            `<button class="btn btn-success" onclick="enableClient('${client.client_id}')">å¯ç”¨</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            const content = document.getElementById('statistics-content');
            content.innerHTML = 'åŠ è½½ç»Ÿè®¡æ•°æ®...';
            
            try {
                const response = await fetch('/api/admin/platform/stats/clients');
                const result = await response.json();
                
                content.innerHTML = `
                    <pre style="background: #f8f9fa; padding: 20px; border-radius: 6px; overflow: auto;">
${JSON.stringify(result, null, 2)}
                    </pre>
                `;
            } catch (error) {
                content.innerHTML = '<div class="error-message">åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfiguration() {
            document.getElementById('config-loading').style.display = 'block';
            document.getElementById('config-form').style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/platform/config');
                const result = await response.json();
                
                if (result.success) {
                    const config = result.data;
                    document.getElementById('platform-enabled').checked = config.enabled;
                    document.getElementById('signature-required').checked = config.signature.required;
                    document.getElementById('timestamp-tolerance').value = config.signature.timestamp_tolerance;
                    document.getElementById('rate-limiting-enabled').checked = config.rate_limiting.enabled;
                    document.getElementById('requests-per-minute').value = config.rate_limiting.requests_per_minute;
                    document.getElementById('requests-per-hour').value = config.rate_limiting.requests_per_hour;
                    
                    platformAdmin.config = config;
                } else {
                    showError('åŠ è½½é…ç½®å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showError('åŠ è½½é…ç½®å¼‚å¸¸: ' + error.message);
            } finally {
                document.getElementById('config-loading').style.display = 'none';
                document.getElementById('config-form').style.display = 'block';
            }
        }

        // å®¢æˆ·ç«¯æ“ä½œå‡½æ•°
        function showAddClientModal() {
            document.getElementById('add-client-modal').style.display = 'block';
        }

        function hideAddClientModal() {
            document.getElementById('add-client-modal').style.display = 'none';
            document.getElementById('add-client-form').reset();
        }

        function refreshClients() {
            loadClients();
        }

        function viewClientDetails(clientId) {
            alert('æŸ¥çœ‹å®¢æˆ·ç«¯è¯¦æƒ…: ' + clientId);
            // è¿™é‡Œå¯ä»¥æ‰“å¼€è¯¦æƒ…æ¨¡æ€æ¡†
        }

        async function enableClient(clientId) {
            try {
                const response = await fetch(`/api/admin/platform/clients/${clientId}/enable`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('å®¢æˆ·ç«¯å·²å¯ç”¨');
                    loadClients();
                } else {
                    showError('å¯ç”¨å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showError('æ“ä½œå¼‚å¸¸: ' + error.message);
            }
        }

        async function disableClient(clientId) {
            if (confirm('ç¡®å®šè¦ç¦ç”¨æ­¤å®¢æˆ·ç«¯å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/admin/platform/clients/${clientId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showSuccess('å®¢æˆ·ç«¯å·²ç¦ç”¨');
                        loadClients();
                    } else {
                        showError('ç¦ç”¨å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    showError('æ“ä½œå¼‚å¸¸: ' + error.message);
                }
            }
        }

        // æ·»åŠ å®¢æˆ·ç«¯è¡¨å•æäº¤
        document.getElementById('add-client-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                client_name: document.getElementById('client-name').value,
                organization: document.getElementById('client-organization').value,
                contact_email: document.getElementById('client-email').value,
                requested_permissions: Array.from(document.querySelectorAll('#add-client-modal input[type="checkbox"]:checked')).map(cb => cb.value),
                description: document.getElementById('client-description').value
            };
            
            try {
                const response = await fetch('/api/admin/platform/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸï¼è¯·ä¿å­˜å¯†é’¥: ' + result.data.secret_key);
                    hideAddClientModal();
                    loadClients();
                } else {
                    showError('åˆ›å»ºå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showError('åˆ›å»ºå¼‚å¸¸: ' + error.message);
            }
        });

        // ä¿å­˜é…ç½®
        async function saveConfiguration() {
            const configData = {
                enabled: document.getElementById('platform-enabled').checked,
                signature: {
                    required: document.getElementById('signature-required').checked,
                    timestamp_tolerance: parseInt(document.getElementById('timestamp-tolerance').value)
                },
                rate_limiting: {
                    enabled: document.getElementById('rate-limiting-enabled').checked,
                    requests_per_minute: parseInt(document.getElementById('requests-per-minute').value),
                    requests_per_hour: parseInt(document.getElementById('requests-per-hour').value)
                }
            };
            
            try {
                const response = await fetch('/api/admin/platform/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('é…ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showError('ä¿å­˜å¼‚å¸¸: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function showError(message) {
            // ç®€å•çš„é”™è¯¯æç¤ºï¼Œå¯ä»¥æ”¹ç”¨æ›´å¥½çš„é€šçŸ¥ç»„ä»¶
            alert('é”™è¯¯: ' + message);
        }

        function showSuccess(message) {
            // ç®€å•çš„æˆåŠŸæç¤º
            alert('æˆåŠŸ: ' + message);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('add-client-modal');
            if (event.target == modal) {
                hideAddClientModal();
            }
        }
    </script>
</body>
</html>