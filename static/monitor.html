<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁõëÊéß‰∏≠ÂøÉ - OCRÊô∫ËÉΩÈ¢ÑÂÆ°Á≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "ÂæÆËΩØÈõÖÈªë", Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* Â§¥ÈÉ®Ê†∑Âºè */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
        }
        
        .header-title .icon {
            margin-right: 12px;
            font-size: 28px;
        }
        
        .header-nav {
            display: flex;
            gap: 24px;
        }
        
        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 10px 18px;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        
        .header-nav a:hover {
            background-color: rgba(255,255,255,0.2);
        }

        /* ËÆ§ËØÅÁä∂ÊÄÅÊòæÁ§∫ */
        .auth-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .auth-status.authenticated {
            color: #52c41a;
        }

        .auth-status.unauthenticated {
            color: #ff4d4f;
        }
        
        /* ‰∏ªÂÆπÂô® */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Tab ÂØºËà™ */
        .tab-nav {
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            overflow-x: auto;
        }

        .tab-nav button {
            background: none;
            border: none;
            padding: 16px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-nav button:hover {
            background: #f0f0f0;
            color: #333;
        }

        .tab-nav button.active {
            color: #1890ff;
            border-bottom: 2px solid #1890ff;
            background: #f0f9ff;
        }

        /* Tab ÂÜÖÂÆπ */
        .tab-content {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .tab-pane {
            display: none;
            padding: 24px;
        }

        .tab-pane.active {
            display: block;
        }

        /* ÁªüËÆ°Âç°Áâá */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: #fafafa;
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
            text-align: center;
        }
        
        .stat-card.success {
            border-left-color: #52c41a;
        }
        
        .stat-card.warning {
            border-left-color: #faad14;
        }
        
        .stat-card.error {
            border-left-color: #ff4d4f;
        }
        
        .stat-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
        }
        
        .stat-card.success .value {
            color: #52c41a;
        }
        
        .stat-card.warning .value {
            color: #faad14;
        }
        
        .stat-card.error .value {
            color: #ff4d4f;
        }

        /* Êï∞ÊçÆË°®Ê†º */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th,
        .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .data-table th {
            background: #fafafa;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        .data-table td {
            color: #666;
        }
        
        .data-table tbody tr:hover {
            background: #f9f9f9;
        }

        /* ËøáÊª§Âô® */
        .filters {
            background: #fafafa;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 4px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 6px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Áä∂ÊÄÅÊ†áÁ≠æ */
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff1f0;
            color: #ff4d4f;
        }
        
        .status-processing {
            background: #e6f7ff;
            color: #1890ff;
        }
        
        .status-completed {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .status-failed {
            background: #fff2e8;
            color: #fa8c16;
        }

        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #d9d9d9;
        }
        
        .btn-secondary:hover {
            background: #e6e6e6;
        }
        
        .btn-small {
            padding: 3px 8px;
            font-size: 11px;
        }

        /* Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .toolbar h2 {
            font-size: 16px;
            color: #333;
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* ÁôªÂΩïË°®Âçï */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus {
            border-color: #1890ff;
            outline: none;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .main-container {
                padding: 16px;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .header-nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .tab-nav {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Â§¥ÈÉ®ÂØºËà™ -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <span class="icon">üìä</span>
                ÁõëÊéß‰∏≠ÂøÉ
            </div>
            <div class="auth-status" id="authStatus">
                <span>Êú™ÁôªÂΩï</span>
                <button class="btn btn-secondary btn-small" onclick="logout()" id="logoutBtn" style="display: none;">ÁôªÂá∫</button>
            </div>
            <div class="header-nav">
                <a href="/static/index.html">È¢ÑÂÆ°È°µÈù¢</a>
                <a href="/static/test-tools.html">ÊµãËØïÂ∑•ÂÖ∑</a>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂÆπÂô® -->
    <div class="main-container">
        <!-- Tab ÂØºËà™ -->
        <div class="tab-nav">
            <button class="active" onclick="switchTab('business')" id="tab-business">
                üìà ‰∏öÂä°ÁªüËÆ°
            </button>
            <button onclick="switchTab('system')" id="tab-system">
                üñ•Ô∏è Á≥ªÁªüÁõëÊéß
            </button>
            <button onclick="switchTab('auth')" id="tab-auth">
                üîê ÁõëÊéßËÆ§ËØÅ
            </button>
        </div>

        <!-- Tab ÂÜÖÂÆπ -->
        <div class="tab-content">
            <!-- ‰∏öÂä°ÁªüËÆ° Tab -->
            <div class="tab-pane active" id="business-pane">
                <!-- ÁªüËÆ°Âç°Áâá -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>ÊÄªÈ¢ÑÂÆ°Ê¨°Êï∞</h3>
                        <div class="value" id="totalCount">-</div>
                    </div>
                    <div class="stat-card success">
                        <h3>ÊàêÂäüÂÆåÊàê</h3>
                        <div class="value" id="completedCount">-</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Â§ÑÁêÜ‰∏≠</h3>
                        <div class="value" id="processingCount">-</div>
                    </div>
                    <div class="stat-card error">
                        <h3>Â§ÑÁêÜÂ§±Ë¥•</h3>
                        <div class="value" id="failedCount">-</div>
                    </div>
                </div>

                <!-- ËøáÊª§Âô® -->
                <div class="filters">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="dateFrom">ÂºÄÂßãÊó•Êúü</label>
                            <input type="date" id="dateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="dateTo">ÁªìÊùüÊó•Êúü</label>
                            <input type="date" id="dateTo">
                        </div>
                        <div class="filter-group">
                            <label for="statusFilter">Áä∂ÊÄÅ</label>
                            <select id="statusFilter">
                                <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                                <option value="pending">ÂæÖÂ§ÑÁêÜ</option>
                                <option value="processing">Â§ÑÁêÜ‰∏≠</option>
                                <option value="completed">Â∑≤ÂÆåÊàê</option>
                                <option value="failed">Â§ÑÁêÜÂ§±Ë¥•</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="matterFilter">‰∫ãÈ°πÂêçÁß∞</label>
                            <input type="text" id="matterFilter" placeholder="ÊêúÁ¥¢‰∫ãÈ°πÂêçÁß∞">
                        </div>
                        <div style="display: flex; gap: 8px; align-items: end;">
                            <button class="btn btn-primary" onclick="applyFilters()">üîç Êü•ËØ¢</button>
                            <button class="btn btn-secondary" onclick="resetFilters()">üîÑ ÈáçÁΩÆ</button>
                        </div>
                    </div>
                </div>

                <!-- Â∑•ÂÖ∑Ê†è -->
                <div class="toolbar">
                    <h2>È¢ÑÂÆ°ËÆ∞ÂΩïÂàóË°®</h2>
                    <div class="toolbar-actions">
                        <button class="btn btn-secondary" onclick="exportBusinessData()">üì• ÂØºÂá∫</button>
                        <button class="btn btn-primary" onclick="refreshBusinessData()">üîÑ Âà∑Êñ∞</button>
                    </div>
                </div>
                
                <!-- Ë°®Ê†ºÂÜÖÂÆπ -->
                <div id="businessTableContent">
                    <div class="loading">Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</div>
                </div>
            </div>

            <!-- Á≥ªÁªüÁõëÊéß Tab -->
            <div class="tab-pane" id="system-pane">
                <!-- Á≥ªÁªüÊåáÊ†áÂç°Áâá -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>CPU‰ΩøÁî®Áéá</h3>
                        <div class="value" id="cpuUsage">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>ÂÜÖÂ≠ò‰ΩøÁî®Áéá</h3>
                        <div class="value" id="memoryUsage">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Á£ÅÁõò‰ΩøÁî®Áéá</h3>
                        <div class="value" id="diskUsage">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>OCRËøõÁ®ãÁä∂ÊÄÅ</h3>
                        <div class="value" id="ocrStatus">-</div>
                    </div>
                </div>

                <!-- Â∑•ÂÖ∑Ê†è -->
                <div class="toolbar">
                    <h2>Á≥ªÁªüÁõëÊéßËØ¶ÊÉÖ</h2>
                    <div class="toolbar-actions">
                        <button class="btn btn-secondary" onclick="exportSystemData()">üì• ÂØºÂá∫</button>
                        <button class="btn btn-primary" onclick="refreshSystemData()">üîÑ Âà∑Êñ∞</button>
                    </div>
                </div>

                <!-- Á≥ªÁªüÁõëÊéßËØ¶ÊÉÖ -->
                <div id="systemTableContent">
                    <div class="loading">Ê≠£Âú®Âä†ËΩΩÁ≥ªÁªüÊï∞ÊçÆ...</div>
                </div>
            </div>

            <!-- ÁõëÊéßËÆ§ËØÅ Tab -->
            <div class="tab-pane" id="auth-pane">
                <!-- ËÆ§ËØÅÁä∂ÊÄÅ -->
                <div id="authContent">
                    <!-- ÁôªÂΩïË°®Âçï -->
                    <div class="login-form" id="loginForm">
                        <h2 style="text-align: center; margin-bottom: 20px;">ÁõëÊéßÁ≥ªÁªüÁôªÂΩï</h2>
                        <div class="form-group">
                            <label for="username">Áî®Êà∑Âêç</label>
                            <input type="text" id="username" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" value="admin">
                        </div>
                        <div class="form-group">
                            <label for="password">ÂØÜÁ†Å</label>
                            <input type="password" id="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="login()" style="width: 100%;">ÁôªÂΩï</button>
                        </div>
                        <p style="text-align: center; color: #666; font-size: 12px;">
                            ÈªòËÆ§Ë¥¶Êà∑Ôºöadmin / admin!@#123
                        </p>
                    </div>

                    <!-- ËÆ§ËØÅÊàêÂäüÂêéÁöÑÁÆ°ÁêÜÁïåÈù¢ -->
                    <div id="authManagement" style="display: none;">
                        <div class="stats-cards">
                            <div class="stat-card">
                                <h3>Ê¥ªË∑É‰ºöËØùÊï∞</h3>
                                <div class="value" id="activeSessions">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>ÁôªÂΩïÊ¨°Êï∞</h3>
                                <div class="value" id="loginCount">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>ÂΩìÂâçÁî®Êà∑</h3>
                                <div class="value" id="currentUser">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>‰ºöËØùÁä∂ÊÄÅ</h3>
                                <div class="value" id="sessionStatus">-</div>
                            </div>
                        </div>

                        <div class="toolbar">
                            <h2>‰ºöËØùÁÆ°ÁêÜ</h2>
                            <div class="toolbar-actions">
                                <button class="btn btn-secondary" onclick="cleanupSessions()">üßπ Ê∏ÖÁêÜËøáÊúü‰ºöËØù</button>
                                <button class="btn btn-primary" onclick="refreshAuthData()">üîÑ Âà∑Êñ∞</button>
                            </div>
                        </div>

                        <div id="authTableContent">
                            <p style="text-align: center; padding: 40px; color: #666;">
                                ‰ºöËØùÁÆ°ÁêÜÂäüËÉΩÊ≠£Â∏∏ËøêË°å‰∏≠
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentPage = 1;
        let pageSize = 20;
        let currentFilters = {};
        let authSession = null;

        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            checkAuthStatus();
            
            // ËÆæÁΩÆÈªòËÆ§Êó•ÊúüËåÉÂõ¥ÔºàÊúÄËøë7Â§©Ôºâ
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
        });

        // ÂàùÂßãÂåñÈ°µÈù¢
        function initializePage() {
            console.log('ÁõëÊéß‰∏≠ÂøÉÈ°µÈù¢ÂàùÂßãÂåñ');
            loadBusinessData();
        }

        // ÂàáÊç¢Tab
        function switchTab(tabName) {
            // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
            document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçtab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`${tabName}-pane`).classList.add('active');

            // Ê†πÊçÆtabÂä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
            switch(tabName) {
                case 'business':
                    loadBusinessData();
                    break;
                case 'system':
                    loadSystemData();
                    break;
                case 'auth':
                    // ËÆ§ËØÅtab‰∏çÈúÄË¶ÅËá™Âä®Âä†ËΩΩÊï∞ÊçÆ
                    break;
            }
        }

        // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
        async function checkAuthStatus() {
            try {
                const sessionId = localStorage.getItem('monitor_session_id');
                if (!sessionId) {
                    updateAuthStatus(false);
                    return;
                }

                const response = await fetch(`/api/monitor/auth/status?session_id=${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        authSession = sessionId;
                        updateAuthStatus(true);
                        showAuthManagement();
                    } else {
                        updateAuthStatus(false);
                    }
                } else {
                    updateAuthStatus(false);
                }
            } catch (error) {
                console.error('Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅÂ§±Ë¥•:', error);
                updateAuthStatus(false);
            }
        }

        // Êõ¥Êñ∞ËÆ§ËØÅÁä∂ÊÄÅÊòæÁ§∫
        function updateAuthStatus(isAuthenticated) {
            const authStatus = document.getElementById('authStatus');
            const logoutBtn = document.getElementById('logoutBtn');

            if (isAuthenticated) {
                authStatus.className = 'auth-status authenticated';
                authStatus.querySelector('span').textContent = 'Â∑≤ÁôªÂΩï';
                logoutBtn.style.display = 'inline-flex';
            } else {
                authStatus.className = 'auth-status unauthenticated';
                authStatus.querySelector('span').textContent = 'Êú™ÁôªÂΩï';
                logoutBtn.style.display = 'none';
                localStorage.removeItem('monitor_session_id');
                authSession = null;
            }
        }

        // ÁôªÂΩï
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                return;
            }

            try {
                const response = await fetch('/api/monitor/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (data.success && data.session) {
                    localStorage.setItem('monitor_session_id', data.session.id);
                    authSession = data.session.id;
                    updateAuthStatus(true);
                    showAuthManagement();
                    alert('ÁôªÂΩïÊàêÂäü');
                } else {
                    alert('ÁôªÂΩïÂ§±Ë¥•: ' + data.message);
                }
            } catch (error) {
                console.error('ÁôªÂΩïÂ§±Ë¥•:', error);
                alert('ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // ÁôªÂá∫
        async function logout() {
            if (!authSession) return;

            try {
                await fetch(`/api/monitor/auth/logout?session_id=${authSession}`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('ÁôªÂá∫ËØ∑Ê±ÇÂ§±Ë¥•:', error);
            }

            updateAuthStatus(false);
            showLoginForm();
        }

        // ÊòæÁ§∫ÁôªÂΩïË°®Âçï
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('authManagement').style.display = 'none';
        }

        // ÊòæÁ§∫ËÆ§ËØÅÁÆ°ÁêÜÁïåÈù¢
        function showAuthManagement() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('authManagement').style.display = 'block';
            refreshAuthData();
        }

        // Âà∑Êñ∞ËÆ§ËØÅÊï∞ÊçÆ
        async function refreshAuthData() {
            if (!authSession) return;

            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            document.getElementById('activeSessions').textContent = '1';
            document.getElementById('loginCount').textContent = '-';
            document.getElementById('currentUser').textContent = 'admin';
            document.getElementById('sessionStatus').textContent = 'Ê¥ªË∑É';
        }

        // Ê∏ÖÁêÜËøáÊúü‰ºöËØù
        async function cleanupSessions() {
            if (!authSession) return;

            try {
                const response = await fetch(`/api/monitor/auth/cleanup?session_id=${authSession}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`Â∑≤Ê∏ÖÁêÜ ${data.data || 0} ‰∏™ËøáÊúü‰ºöËØù`);
                    refreshAuthData();
                } else {
                    alert('Ê∏ÖÁêÜ‰ºöËØùÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜ‰ºöËØùÂ§±Ë¥•:', error);
                alert('Ê∏ÖÁêÜ‰ºöËØùÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // Âä†ËΩΩ‰∏öÂä°Êï∞ÊçÆ
        function loadBusinessData() {
            loadStatistics();
            loadPreviewRecords();
        }

        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        async function loadStatistics() {
            try {
                const response = await fetch('/api/preview/statistics');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateStatisticsDisplay(data.data);
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
                updateStatisticsDisplay({
                    total: 0,
                    completed: 0,
                    processing: 0,
                    failed: 0
                });
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
        function updateStatisticsDisplay(stats) {
            document.getElementById('totalCount').textContent = stats.total || 0;
            document.getElementById('completedCount').textContent = stats.completed || 0;
            document.getElementById('processingCount').textContent = stats.processing || 0;
            document.getElementById('failedCount').textContent = stats.failed || 0;
        }

        // Âä†ËΩΩÈ¢ÑÂÆ°ËÆ∞ÂΩï
        async function loadPreviewRecords() {
            const tableContent = document.getElementById('businessTableContent');
            tableContent.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</div>';

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    size: pageSize,
                    ...currentFilters
                });

                const response = await fetch(`/api/preview/records?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayPreviewRecords(data.data.records || []);
                    } else {
                        showEmptyState(tableContent, 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + data.errorMsg);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈ¢ÑÂÆ°ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showEmptyState(tableContent, 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // ÊòæÁ§∫È¢ÑÂÆ°ËÆ∞ÂΩï
        function displayPreviewRecords(records) {
            const tableContent = document.getElementById('businessTableContent');
            
            if (!records || records.length === 0) {
                showEmptyState(tableContent, 'ÊöÇÊó†Êï∞ÊçÆ');
                return;
            }

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>È¢ÑÂÆ°ID</th>
                            <th>Á¨¨‰∏âÊñπËØ∑Ê±ÇID</th>
                            <th>‰∫ãÈ°πÂêçÁß∞</th>
                            <th>Áî®Êà∑ID</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>ËØ∑Ê±ÇÊó∂Èó¥</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr>
                                <td><code style="font-size: 11px;">${record.id || '-'}</code></td>
                                <td><code style="font-size: 11px;">${record.third_party_request_id || '-'}</code></td>
                                <td>${record.matter_name || '-'}</td>
                                <td>${record.user_id || '-'}</td>
                                <td>${formatStatus(record.status)}</td>
                                <td>${formatDateTime(record.created_at)}</td>
                                <td>
                                    <button class="btn btn-small btn-primary" onclick="viewPreview('${record.id}')">Êü•Áúã</button>
                                    ${record.status === 'completed' ? 
                                        `<button class="btn btn-small btn-secondary" onclick="downloadResult('${record.id}')">‰∏ãËΩΩ</button>` : 
                                        ''
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            tableContent.innerHTML = table;
        }

        // Âä†ËΩΩÁ≥ªÁªüÊï∞ÊçÆ
        async function loadSystemData() {
            loadSystemMetrics();
            loadSystemDetails();
        }

        // Âä†ËΩΩÁ≥ªÁªüÊåáÊ†á
        async function loadSystemMetrics() {
            try {
                const response = await fetch('/api/monitoring/status');
                if (response.ok) {
                    const data = await response.json();
                    updateSystemMetrics(data);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≥ªÁªüÊåáÊ†áÂ§±Ë¥•:', error);
                updateSystemMetrics({});
            }
        }

        // Êõ¥Êñ∞Á≥ªÁªüÊåáÊ†áÊòæÁ§∫
        function updateSystemMetrics(metrics) {
            document.getElementById('cpuUsage').textContent = (metrics.cpu_usage || 0) + '%';
            document.getElementById('memoryUsage').textContent = (metrics.memory_usage || 0) + '%';
            document.getElementById('diskUsage').textContent = (metrics.disk_usage || 0) + '%';
            document.getElementById('ocrStatus').textContent = metrics.ocr_status || 'Êú™Áü•';
        }

        // Âä†ËΩΩÁ≥ªÁªüËØ¶ÊÉÖ
        async function loadSystemDetails() {
            const tableContent = document.getElementById('systemTableContent');
            tableContent.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÁ≥ªÁªüÊï∞ÊçÆ...</div>';

            try {
                const response = await fetch('/api/health/details');
                if (response.ok) {
                    const data = await response.json();
                    displaySystemDetails(data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≥ªÁªüËØ¶ÊÉÖÂ§±Ë¥•:', error);
                showEmptyState(tableContent, 'Á≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // ÊòæÁ§∫Á≥ªÁªüËØ¶ÊÉÖ
        function displaySystemDetails(details) {
            const tableContent = document.getElementById('systemTableContent');
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ÁªÑ‰ª∂</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>ËØ¶ÊÉÖ</th>
                            <th>ÊúÄÂêéÊ£ÄÊü•Êó∂Èó¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Êï∞ÊçÆÂ∫ìËøûÊé•</td>
                            <td>${formatStatus(details.database ? 'completed' : 'failed')}</td>
                            <td>${details.database ? 'ËøûÊé•Ê≠£Â∏∏' : 'ËøûÊé•ÂºÇÂ∏∏'}</td>
                            <td>${new Date().toLocaleString('zh-CN')}</td>
                        </tr>
                        <tr>
                            <td>Â≠òÂÇ®Á≥ªÁªü</td>
                            <td>${formatStatus(details.storage ? 'completed' : 'failed')}</td>
                            <td>${details.storage ? 'Â≠òÂÇ®Ê≠£Â∏∏' : 'Â≠òÂÇ®ÂºÇÂ∏∏'}</td>
                            <td>${new Date().toLocaleString('zh-CN')}</td>
                        </tr>
                        <tr>
                            <td>OCRÊúçÂä°</td>
                            <td>${formatStatus(details.ocr ? 'completed' : 'warning')}</td>
                            <td>${details.ocr ? 'OCRÊúçÂä°Ê≠£Â∏∏' : 'OCRÊúçÂä°Ê£ÄÊü•‰∏≠'}</td>
                            <td>${new Date().toLocaleString('zh-CN')}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            tableContent.innerHTML = table;
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showEmptyState(container, message) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>${message}</p>
                </div>
            `;
        }

        function formatStatus(status) {
            const statusMap = {
                'pending': '<span class="status-badge status-pending">ÂæÖÂ§ÑÁêÜ</span>',
                'processing': '<span class="status-badge status-processing">Â§ÑÁêÜ‰∏≠</span>',
                'completed': '<span class="status-badge status-completed">Ê≠£Â∏∏</span>',
                'failed': '<span class="status-badge status-failed">ÂºÇÂ∏∏</span>'
            };
            return statusMap[status] || status;
        }

        function formatDateTime(dateTime) {
            if (!dateTime) return '-';
            return new Date(dateTime).toLocaleString('zh-CN');
        }

        // ËøáÊª§Âô®Áõ∏ÂÖ≥
        function applyFilters() {
            currentFilters = {
                date_from: document.getElementById('dateFrom').value,
                date_to: document.getElementById('dateTo').value,
                status: document.getElementById('statusFilter').value,
                matter_name: document.getElementById('matterFilter').value
            };

            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });

            currentPage = 1;
            loadPreviewRecords();
            loadStatistics();
        }

        function resetFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('matterFilter').value = '';
            
            currentFilters = {};
            currentPage = 1;
            loadPreviewRecords();
            loadStatistics();
        }

        // Âà∑Êñ∞Êï∞ÊçÆ
        function refreshBusinessData() {
            loadBusinessData();
        }

        function refreshSystemData() {
            loadSystemData();
        }

        // Êìç‰ΩúÂáΩÊï∞
        function viewPreview(previewId) {
            const url = `/static/index.html?previewId=${previewId}&verified=true`;
            window.open(url, '_blank');
        }

        function downloadResult(previewId) {
            const url = `/api/download?file=${previewId}.pdf`;
            window.open(url, '_blank');
        }

        function exportBusinessData() {
            const params = new URLSearchParams({
                export: 'csv',
                ...currentFilters
            });
            
            const url = `/api/preview/records?${params}`;
            window.open(url, '_blank');
        }

        function exportSystemData() {
            alert('Á≥ªÁªüÊï∞ÊçÆÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠');
        }
    </script>
</body>
</html>