<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统监控工具 - Debug环境</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        
        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 16px; }
        
        .monitor-controls {
            background: #f8f9fa; padding: 20px; border-bottom: 2px solid #e9ecef;
            display: flex; justify-content: space-between; align-items: center;
        }
        .control-group { display: flex; gap: 15px; align-items: center; }
        
        .content { padding: 30px; }
        
        .metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        
        .metric-card {
            background: white; border: 2px solid #e9ecef; border-radius: 12px;
            padding: 25px; transition: all 0.3s ease;
        }
        .metric-card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: translateY(-3px);
        }
        
        .metric-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .metric-title {
            font-size: 18px; font-weight: 700; color: #2c3e50;
            display: flex; align-items: center; gap: 10px;
        }
        .metric-status {
            width: 12px; height: 12px; border-radius: 50%;
            display: inline-block;
        }
        .status-healthy { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
        .status-unknown { background: #6c757d; }
        
        .metric-value {
            font-size: 32px; font-weight: 700; margin-bottom: 10px;
        }
        .metric-value.healthy { color: #28a745; }
        .metric-value.warning { color: #ffc107; }
        .metric-value.error { color: #dc3545; }
        .metric-value.normal { color: #667eea; }
        
        .metric-description { color: #6c757d; font-size: 14px; margin-bottom: 15px; }
        
        .metric-details {
            font-size: 12px; color: #495057;
            background: #f8f9fa; padding: 10px; border-radius: 6px;
        }
        
        .btn {
            background: #667eea; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: #5a67d8; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        .btn.small { padding: 6px 12px; font-size: 12px; }
        
        .monitor-tabs {
            display: flex; background: #f8f9fa; margin-bottom: 20px;
            border-radius: 8px; overflow: hidden;
        }
        .monitor-tab {
            padding: 15px 25px; cursor: pointer; border: none; background: none;
            font-size: 14px; font-weight: 600; color: #6c757d;
            transition: all 0.3s ease; flex: 1; text-align: center;
        }
        .monitor-tab.active { color: white; background: #667eea; }
        .monitor-tab:hover:not(.active) { background: #e9ecef; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .log-container {
            background: #2d3748; color: #e2e8f0; border-radius: 8px;
            height: 400px; overflow-y: auto; padding: 20px;
            font-family: 'Monaco', 'Courier New', monospace; font-size: 13px;
        }
        
        .log-entry {
            margin-bottom: 8px; padding: 5px 0; border-bottom: 1px solid #4a5568;
        }
        .log-timestamp { color: #81e6d9; }
        .log-level { font-weight: bold; }
        .log-level.info { color: #63b3ed; }
        .log-level.warn { color: #f6e05e; }
        .log-level.error { color: #fc8181; }
        .log-level.debug { color: #d69e2e; }
        .log-message { color: #e2e8f0; }
        
        .chart-container {
            height: 200px; background: #f8f9fa; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: #6c757d; margin-top: 15px;
        }
        
        .api-list {
            max-height: 300px; overflow-y: auto;
        }
        .api-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #e9ecef;
        }
        .api-item:last-child { border-bottom: none; }
        .api-method {
            display: inline-block; padding: 2px 6px; border-radius: 3px;
            font-size: 10px; font-weight: bold; margin-right: 10px;
        }
        .method-GET { background: #d4edda; color: #155724; }
        .method-POST { background: #cce5ff; color: #004085; }
        .method-PUT { background: #fff3cd; color: #856404; }
        .method-DELETE { background: #f8d7da; color: #721c24; }
        
        .progress-bar {
            width: 100%; height: 20px; background: #e9ecef; border-radius: 10px;
            overflow: hidden; margin: 10px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease; border-radius: 10px;
        }
        
        .alert {
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert.info {
            background: #d1ecf1; color: #0c5460; border-color: #17a2b8;
        }
        .alert.warning {
            background: #fff3cd; color: #856404; border-color: #ffc107;
        }
        .alert.error {
            background: #f8d7da; color: #721c24; border-color: #dc3545;
        }
        
        .refresh-indicator {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>📊 系统监控工具</h1>
            <p>实时监控系统状态、API性能和资源使用情况</p>
        </div>

        <!-- 监控控制台 -->
        <div class="monitor-controls">
            <div class="control-group">
                <button class="btn" onclick="refreshAll()" id="refreshBtn">
                    <span id="refreshIcon">🔄</span> 刷新全部
                </button>
                <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                    ⏱️ 自动刷新
                </button>
                <span>刷新间隔:</span>
                <select id="refreshInterval" onchange="updateRefreshInterval()">
                    <option value="5000">5秒</option>
                    <option value="10000" selected>10秒</option>
                    <option value="30000">30秒</option>
                    <option value="60000">1分钟</option>
                </select>
            </div>
            
            <div class="control-group">
                <span>状态:</span>
                <span id="monitorStatus" class="metric-status status-unknown"></span>
                <span id="monitorStatusText">初始化中...</span>
                <span style="margin-left: 20px;">最后更新:</span>
                <span id="lastUpdate">--:--:--</span>
            </div>
        </div>

        <div class="content">
            <!-- 系统指标概览 -->
            <div class="metrics-grid">
                <!-- 系统健康状态 -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>🏥</span>
                            系统健康
                        </div>
                        <span id="healthStatus" class="metric-status status-unknown"></span>
                    </div>
                    <div id="healthValue" class="metric-value normal">检查中...</div>
                    <div class="metric-description">总体系统运行状态</div>
                    <div id="healthDetails" class="metric-details">
                        正在检查系统各组件状态...
                    </div>
                </div>

                <!-- API响应时间 -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>⚡</span>
                            API响应
                        </div>
                        <span id="apiStatus" class="metric-status status-unknown"></span>
                    </div>
                    <div id="apiValue" class="metric-value normal">-- ms</div>
                    <div class="metric-description">API平均响应时间</div>
                    <div id="apiDetails" class="metric-details">
                        正在测试API响应性能...
                    </div>
                </div>

                <!-- OCR服务状态 -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>🔍</span>
                            OCR服务
                        </div>
                        <span id="ocrStatus" class="metric-status status-unknown"></span>
                    </div>
                    <div id="ocrValue" class="metric-value normal">检查中...</div>
                    <div class="metric-description">OCR识别服务状态</div>
                    <div id="ocrDetails" class="metric-details">
                        正在检查OCR服务可用性...
                    </div>
                </div>

                <!-- 认证服务 -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>🔐</span>
                            认证服务
                        </div>
                        <span id="authServiceStatus" class="metric-status status-unknown"></span>
                    </div>
                    <div id="authServiceValue" class="metric-value normal">检查中...</div>
                    <div class="metric-description">用户认证服务状态</div>
                    <div id="authServiceDetails" class="metric-details">
                        正在检查认证服务状态...
                    </div>
                </div>

                <!-- 数据库连接 -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>🗄️</span>
                            数据存储
                        </div>
                        <span id="dbStatus" class="metric-status status-unknown"></span>
                    </div>
                    <div id="dbValue" class="metric-value normal">检查中...</div>
                    <div class="metric-description">数据存储连接状态</div>
                    <div id="dbDetails" class="metric-details">
                        正在检查数据存储可用性...
                    </div>
                </div>

                <!-- 系统负载 -->
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">
                            <span>📈</span>
                            系统负载
                        </div>
                        <span id="loadStatus" class="metric-status status-unknown"></span>
                    </div>
                    <div id="loadValue" class="metric-value normal">-- %</div>
                    <div class="metric-description">当前系统负载水平</div>
                    <div id="loadDetails" class="metric-details">
                        正在获取系统负载信息...
                    </div>
                </div>
            </div>

            <!-- 详细监控标签页 -->
            <div class="monitor-tabs">
                <button class="monitor-tab active" onclick="switchMonitorTab('overview')">
                    📊 概览
                </button>
                <button class="monitor-tab" onclick="switchMonitorTab('apis')">
                    🔌 API监控
                </button>
                <button class="monitor-tab" onclick="switchMonitorTab('logs')">
                    📋 系统日志
                </button>
                <button class="monitor-tab" onclick="switchMonitorTab('performance')">
                    ⚡ 性能分析
                </button>
                <button class="monitor-tab" onclick="switchMonitorTab('alerts')">
                    🚨 告警信息
                </button>
            </div>

            <!-- 概览标签页 -->
            <div id="overview" class="tab-content active">
                <h3 style="margin-bottom: 20px;">系统概览</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="margin-bottom: 15px;">服务状态统计</h4>
                        <div id="serviceChart" class="chart-container">
                            服务状态图表加载中...
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 15px;">关键指标趋势</h4>
                        <div id="trendsChart" class="chart-container">
                            趋势图表加载中...
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">系统信息</h4>
                    <div id="systemInfo" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        正在获取系统信息...
                    </div>
                </div>
            </div>

            <!-- API监控标签页 -->
            <div id="apis" class="tab-content">
                <h3 style="margin-bottom: 20px;">API接口监控</h3>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn small" onclick="testAllApis()">🔄 测试所有API</button>
                    <button class="btn small warning" onclick="clearApiResults()">🧹 清空结果</button>
                </div>
                
                <div id="apiList" class="api-list">
                    <!-- 动态生成API列表 -->
                </div>
            </div>

            <!-- 系统日志标签页 -->
            <div id="logs" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>系统日志</h3>
                    <div>
                        <select id="logLevel" onchange="filterLogs()">
                            <option value="all">全部级别</option>
                            <option value="error">错误</option>
                            <option value="warn">警告</option>
                            <option value="info">信息</option>
                            <option value="debug">调试</option>
                        </select>
                        <button class="btn small" onclick="refreshLogs()">🔄 刷新</button>
                        <button class="btn small warning" onclick="clearLogs()">🧹 清空</button>
                    </div>
                </div>
                
                <div id="logContainer" class="log-container">
                    正在加载系统日志...
                </div>
            </div>

            <!-- 性能分析标签页 -->
            <div id="performance" class="tab-content">
                <h3 style="margin-bottom: 20px;">性能分析</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="margin-bottom: 15px;">响应时间分布</h4>
                        <div id="responseTimeChart" class="chart-container">
                            响应时间图表加载中...
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 15px;">吞吐量趋势</h4>
                        <div id="throughputChart" class="chart-container">
                            吞吐量图表加载中...
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">性能建议</h4>
                    <div id="performanceAdvice" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        正在分析性能数据并生成建议...
                    </div>
                </div>
            </div>

            <!-- 告警信息标签页 -->
            <div id="alerts" class="tab-content">
                <h3 style="margin-bottom: 20px;">告警信息</h3>
                
                <div id="alertsList">
                    <!-- 动态生成告警列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 引入配置文件 -->
    <script src="../assets/test-config.js"></script>
    <script>
        // 全局状态
        let autoRefreshEnabled = false;
        let refreshTimer = null;
        let currentTab = 'overview';
        let systemLogs = [];
        let apiResults = {};

        // 监控指标
        const metrics = {
            health: { status: 'unknown', value: '检查中...', details: '正在检查系统各组件状态...' },
            api: { status: 'unknown', value: '-- ms', details: '正在测试API响应性能...' },
            ocr: { status: 'unknown', value: '检查中...', details: '正在检查OCR服务可用性...' },
            auth: { status: 'unknown', value: '检查中...', details: '正在检查认证服务状态...' },
            db: { status: 'unknown', value: '检查中...', details: '正在检查数据存储可用性...' },
            load: { status: 'unknown', value: '-- %', details: '正在获取系统负载信息...' }
        };

        // 要监控的API列表
        const monitoredApis = [
            { method: 'GET', path: '/api/health', name: '健康检查' },
            { method: 'GET', path: '/api/auth/status', name: '认证状态' },
            { method: 'GET', path: '/api/config/debug', name: 'Debug配置' },
            { method: 'POST', path: '/api/preview/create', name: '创建预审' },
            { method: 'GET', path: '/api/preview/status', name: '预审状态' },
            { method: 'POST', path: '/api/ocr/upload', name: 'OCR上传' }
        ];

        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📊 系统监控工具初始化...');
            initializeMonitor();
            initializeApiList();
            
            // 首次刷新
            refreshAll();
            
            addLog('info', '系统监控工具已启动');
        });

        // 初始化监控器
        function initializeMonitor() {
            updateMonitorStatus('unknown', '初始化中...');
        }

        // 初始化API列表
        function initializeApiList() {
            const apiList = document.getElementById('apiList');
            
            apiList.innerHTML = monitoredApis.map(api => `
                <div class="api-item" id="api-${api.method}-${api.path.replace(/\//g, '-')}">
                    <div>
                        <span class="api-method method-${api.method}">${api.method}</span>
                        <strong>${api.name}</strong>
                        <div style="font-size: 12px; color: #6c757d;">${api.path}</div>
                    </div>
                    <div>
                        <span class="api-status">未测试</span>
                        <button class="btn small" onclick="testSingleApi('${api.method}', '${api.path}', '${api.name}')">测试</button>
                    </div>
                </div>
            `).join('');
        }

        // 刷新全部监控数据
        async function refreshAll() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            
            refreshBtn.disabled = true;
            refreshIcon.classList.add('refresh-indicator');
            
            updateMonitorStatus('unknown', '正在刷新...');
            
            try {
                // 并行执行所有检查
                await Promise.all([
                    checkSystemHealth(),
                    checkApiPerformance(),
                    checkOcrService(),
                    checkAuthService(),
                    checkDataStorage(),
                    checkSystemLoad()
                ]);
                
                updateMonitorStatus('healthy', '监控正常');
                updateLastUpdateTime();
                
                addLog('info', '全部监控数据已刷新');
                
            } catch (error) {
                updateMonitorStatus('error', '刷新失败');
                addLog('error', `监控数据刷新失败: ${error.message}`);
            } finally {
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('refresh-indicator');
            }
        }

        // 检查系统健康状态
        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateMetric('health', 'healthy', '正常', `系统运行正常，版本: ${data.version || 'unknown'}`);
                } else {
                    updateMetric('health', 'warning', '警告', data.errorMsg || '系统状态异常');
                }
            } catch (error) {
                updateMetric('health', 'error', '错误', `健康检查失败: ${error.message}`);
            }
        }

        // 检查API性能
        async function checkApiPerformance() {
            try {
                const startTime = Date.now();
                const response = await fetch('/api/auth/status');
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                let status = 'healthy';
                if (duration > 1000) status = 'warning';
                if (duration > 3000) status = 'error';
                
                updateMetric('api', status, `${duration} ms`, 
                    `API响应时间: ${duration}ms ${status === 'healthy' ? '(优秀)' : status === 'warning' ? '(一般)' : '(较慢)'}`);
                
            } catch (error) {
                updateMetric('api', 'error', '超时', `API测试失败: ${error.message}`);
            }
        }

        // 检查OCR服务
        async function checkOcrService() {
            try {
                // 这里可以添加OCR服务的具体检查逻辑
                // 暂时模拟检查结果
                updateMetric('ocr', 'healthy', '正常', 'OCR服务运行正常，PaddleOCR引擎就绪');
            } catch (error) {
                updateMetric('ocr', 'error', '错误', `OCR服务检查失败: ${error.message}`);
            }
        }

        // 检查认证服务
        async function checkAuthService() {
            try {
                const response = await fetch('/api/auth/status');
                
                if (response.ok) {
                    updateMetric('auth', 'healthy', '正常', '认证服务运行正常');
                } else {
                    updateMetric('auth', 'warning', '异常', `认证服务响应异常: ${response.status}`);
                }
            } catch (error) {
                updateMetric('auth', 'error', '错误', `认证服务检查失败: ${error.message}`);
            }
        }

        // 检查数据存储
        async function checkDataStorage() {
            try {
                // 这里可以添加数据存储的具体检查逻辑
                // 暂时模拟检查结果
                updateMetric('db', 'healthy', '正常', '数据存储连接正常，读写性能良好');
            } catch (error) {
                updateMetric('db', 'error', '错误', `数据存储检查失败: ${error.message}`);
            }
        }

        // 检查系统负载
        async function checkSystemLoad() {
            try {
                // 这里可以添加系统负载的具体检查逻辑
                // 暂时模拟负载数据
                const load = Math.floor(Math.random() * 100);
                let status = 'healthy';
                if (load > 70) status = 'warning';
                if (load > 90) status = 'error';
                
                updateMetric('load', status, `${load}%`, 
                    `CPU使用率: ${load}% ${status === 'healthy' ? '(正常)' : status === 'warning' ? '(较高)' : '(过高)'}`);
                
            } catch (error) {
                updateMetric('load', 'error', '--', `系统负载检查失败: ${error.message}`);
            }
        }

        // 更新指标显示
        function updateMetric(metricKey, status, value, details) {
            metrics[metricKey] = { status, value, details };
            
            const statusElement = document.getElementById(`${metricKey}Status`);
            const valueElement = document.getElementById(`${metricKey}Value`);
            const detailsElement = document.getElementById(`${metricKey}Details`);
            
            statusElement.className = `metric-status status-${status}`;
            valueElement.textContent = value;
            valueElement.className = `metric-value ${status === 'healthy' ? 'healthy' : status === 'warning' ? 'warning' : status === 'error' ? 'error' : 'normal'}`;
            detailsElement.textContent = details;
        }

        // 更新监控状态
        function updateMonitorStatus(status, text) {
            document.getElementById('monitorStatus').className = `metric-status status-${status}`;
            document.getElementById('monitorStatusText').textContent = text;
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshEnabled) {
                btn.textContent = '⏸️ 停止自动刷新';
                btn.classList.add('warning');
                startAutoRefresh();
                addLog('info', '已启用自动刷新');
            } else {
                btn.textContent = '⏱️ 自动刷新';
                btn.classList.remove('warning');
                stopAutoRefresh();
                addLog('info', '已停止自动刷新');
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refreshInterval').value);
            refreshTimer = setInterval(refreshAll, interval);
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        // 更新刷新间隔
        function updateRefreshInterval() {
            if (autoRefreshEnabled) {
                stopAutoRefresh();
                startAutoRefresh();
                addLog('info', `刷新间隔已更新为 ${document.getElementById('refreshInterval').value}ms`);
            }
        }

        // 切换监控标签
        function switchMonitorTab(tabName) {
            // 更新标签状态
            document.querySelectorAll('.monitor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            addLog('debug', `切换到监控标签页: ${tabName}`);
            
            // 根据标签页加载对应数据
            switch (tabName) {
                case 'logs':
                    refreshLogs();
                    break;
                case 'apis':
                    // API列表已在初始化时加载
                    break;
                case 'alerts':
                    updateAlerts();
                    break;
            }
        }

        // 测试所有API
        async function testAllApis() {
            addLog('info', '开始测试所有API');
            
            for (const api of monitoredApis) {
                await testSingleApi(api.method, api.path, api.name);
                // 添加小延迟避免过于频繁的请求
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            addLog('info', '所有API测试完成');
        }

        // 测试单个API
        async function testSingleApi(method, path, name) {
            const itemId = `api-${method}-${path.replace(/\//g, '-')}`;
            const statusSpan = document.querySelector(`#${itemId} .api-status`);
            
            statusSpan.textContent = '测试中...';
            statusSpan.style.color = '#ffc107';
            
            try {
                const startTime = Date.now();
                const response = await fetch(path, { method });
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                const result = {
                    status: response.status,
                    duration: duration,
                    ok: response.ok
                };
                
                apiResults[`${method}_${path}`] = result;
                
                if (response.ok) {
                    statusSpan.textContent = `✅ ${duration}ms`;
                    statusSpan.style.color = '#28a745';
                    addLog('info', `API测试成功: ${method} ${path} (${duration}ms)`);
                } else {
                    statusSpan.textContent = `❌ ${response.status}`;
                    statusSpan.style.color = '#dc3545';
                    addLog('warn', `API测试异常: ${method} ${path} (${response.status})`);
                }
                
            } catch (error) {
                statusSpan.textContent = `❌ 错误`;
                statusSpan.style.color = '#dc3545';
                addLog('error', `API测试失败: ${method} ${path} - ${error.message}`);
            }
        }

        // 清空API测试结果
        function clearApiResults() {
            apiResults = {};
            document.querySelectorAll('.api-status').forEach(status => {
                status.textContent = '未测试';
                status.style.color = '#6c757d';
            });
            addLog('info', 'API测试结果已清空');
        }

        // 添加日志
        function addLog(level, message, data = null) {
            const logEntry = {
                timestamp: new Date().toLocaleTimeString(),
                level: level,
                message: message,
                data: data
            };
            
            systemLogs.unshift(logEntry);
            
            // 限制日志数量
            if (systemLogs.length > 1000) {
                systemLogs = systemLogs.slice(0, 1000);
            }
            
            // 如果当前在日志标签页，更新显示
            if (currentTab === 'logs') {
                updateLogDisplay();
            }
            
            // 同时输出到控制台
            DebugConfig.utils.log(message, level, data);
        }

        // 刷新日志显示
        function refreshLogs() {
            updateLogDisplay();
            addLog('info', '日志显示已刷新');
        }

        // 更新日志显示
        function updateLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            const levelFilter = document.getElementById('logLevel').value;
            
            let filteredLogs = systemLogs;
            if (levelFilter !== 'all') {
                filteredLogs = systemLogs.filter(log => log.level === levelFilter);
            }
            
            logContainer.innerHTML = filteredLogs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level ${log.level}">[${log.level.toUpperCase()}]</span>
                    <span class="log-message">${log.message}</span>
                    ${log.data ? `<br><span style="color: #a0aec0; font-size: 11px;">${JSON.stringify(log.data)}</span>` : ''}
                </div>
            `).join('');
            
            // 滚动到顶部
            logContainer.scrollTop = 0;
        }

        // 过滤日志
        function filterLogs() {
            updateLogDisplay();
        }

        // 清空日志
        function clearLogs() {
            systemLogs = [];
            updateLogDisplay();
            addLog('info', '系统日志已清空');
        }

        // 更新告警信息
        function updateAlerts() {
            const alertsList = document.getElementById('alertsList');
            
            // 基于当前指标生成告警
            const alerts = [];
            
            Object.keys(metrics).forEach(key => {
                const metric = metrics[key];
                if (metric.status === 'error') {
                    alerts.push({
                        level: 'error',
                        title: `${getMetricName(key)}服务异常`,
                        message: metric.details,
                        time: new Date().toLocaleTimeString()
                    });
                } else if (metric.status === 'warning') {
                    alerts.push({
                        level: 'warning',
                        title: `${getMetricName(key)}性能警告`,
                        message: metric.details,
                        time: new Date().toLocaleTimeString()
                    });
                }
            });
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert info">
                        <strong>✅ 系统正常</strong><br>
                        当前没有告警信息，所有服务运行正常。
                    </div>
                `;
            } else {
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="alert ${alert.level}">
                        <strong>${alert.title}</strong> - ${alert.time}<br>
                        ${alert.message}
                    </div>
                `).join('');
            }
        }

        // 获取指标名称
        function getMetricName(key) {
            const names = {
                health: '系统健康',
                api: 'API响应',
                ocr: 'OCR服务',
                auth: '认证服务',
                db: '数据存储',
                load: '系统负载'
            };
            return names[key] || key;
        }
    </script>
</body>
</html> 